#!/usr/bin/env python3
"""
–ü—Ä–∏–º–µ—Ä —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ llm_clustering —Å Ollama.
–°—Ç–∏–ª—å "Python Notebook" - –ª–∏–Ω–µ–π–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –±–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏ main.

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç:
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Ollama –≤ –∫–∞—á–µ—Å—Ç–≤–µ LLM-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
2. –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—é –æ–±—Ä–∞—â–µ–Ω–∏–π –∏–∑ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö
3. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ —á–µ—Ä–µ–∑ business_context

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ó–∞–ø—É—â–µ–Ω–Ω—ã–π Ollama: ollama serve
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å: ollama pull qwen3:30b-a3b (–∏–ª–∏ –¥—Ä—É–≥–∞—è)
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞: pip install -e .
"""

import sys
import os
from pathlib import Path
from datetime import datetime
import traceback
import pandas as pd

# =========================================================================
# –ù–ê–°–¢–†–û–ô–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø
# =========================================================================

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
try:
    # –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–∫ —Å–∫—Ä–∏–ø—Ç
    PROJECT_ROOT = Path(__file__).parent.parent
except NameError:
    # –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤ Jupyter Notebook
    PROJECT_ROOT = Path(os.getcwd())

# –î–æ–±–∞–≤–ª—è–µ–º src –≤ –ø—É—Ç—å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞, –µ—Å–ª–∏ –µ–≥–æ —Ç–∞–º –Ω–µ—Ç
if str(PROJECT_ROOT / "src") not in sys.path:
    sys.path.insert(0, str(PROJECT_ROOT / "src"))

from llm_clustering import ClusteringPipeline, Settings
from llm_clustering.llm import OllamaProvider

# =========================================================================
# –ü–ê–†–ê–ú–ï–¢–†–´ –ó–ê–ü–£–°–ö–ê (–ù–ê–°–¢–†–û–ô–ö–ò)
# =========================================================================

# –î–∞–Ω–Ω—ã–µ
DEMO_FILE_PATH = PROJECT_ROOT / "ai_data" / "demo_sample.csv"
LIMIT_ROWS = 1000  # –°–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –∑–∞–≥—Ä—É–∂–∞—Ç—å

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
CLUSTERING_BATCH_SIZE = 50      # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø–æ 50 –æ–±—Ä–∞—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑
MAX_CLUSTERS_PER_BATCH = 10     # –ú–∞–∫—Å–∏–º—É–º 10 –Ω–æ–≤—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∑–∞ –±–∞—Ç—á
MIN_REQUESTS_PER_CLUSTER = 3    # –ú–∏–Ω–∏–º—É–º 3 –æ–±—Ä–∞—â–µ–Ω–∏—è –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∞
LLM_TEMPERATURE = 0.6           # –°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
LLM_MAX_TOKENS = 16000          # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤
PARALLEL_BATCH_SIZE = 5         # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å 5 –æ–±—Ä–∞—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Ollama (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–¥–µ—Å—å –∏–ª–∏ –±—Ä–∞—Ç—å –∏–∑ .env)
# –ï—Å–ª–∏ None, –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ .env –∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
OLLAMA_URL = None   # –ù–∞–ø—Ä–∏–º–µ—Ä: "http://localhost:11434/api"
OLLAMA_MODEL = None # –ù–∞–ø—Ä–∏–º–µ—Ä: "qwen3:30b-a3b"

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
OUTPUT_DIR = PROJECT_ROOT / "ai_data" / "standalone_example_results"


# =========================================================================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# =========================================================================

def load_demo_data(path: Path, limit: int = 1000) -> pd.DataFrame:
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –∏–∑ CSV."""
    if not path.exists():
        raise FileNotFoundError(
            f"–î–µ–º–æ-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {path}\n"
            "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª ai_data/demo_sample.csv —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
        )
    
    print(f"–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ {path}...")
    df = pd.read_csv(path)
    
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
    if len(df) > limit:
        df = df.head(limit)
    
    print(f"‚úì –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(df)} –æ–±—Ä–∞—â–µ–Ω–∏–π")
    return df

def create_custom_business_context() -> str:
    """–°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏."""
    return """
    ## –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏
    –¢—ã –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –æ–±—Ä–∞—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ç–µ–ª–µ–∫–æ–º-–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ Union Mobile.
    
    ## –¶–µ–ª—å –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
    –†–∞–∑–¥–µ–ª–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–ª—è:
    1. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ —á–∞—Ç-–±–æ—Ç–∞
    2. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º
    3. –í—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω –≤ —Å–µ—Ä–≤–∏—Å–µ
    
    ## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏
    - **–ü—Ä–æ—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã**: FAQ, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–ª–µ–≥–∫–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å)
    - **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã**: –ù–µ–ø–æ–ª–∞–¥–∫–∏ —Å —Å–µ—Ä–≤–∏—Å–æ–º, —Ç—Ä–µ–±—É—é—â–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    - **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º**: –°–º–µ–Ω–∞ —Ç–∞—Ä–∏—Ñ–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –±–∏–ª–ª–∏–Ω–≥
    - **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏**: –ñ–∞–ª–æ–±—ã, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–ø–æ—Ä—ã, —ç—Å–∫–∞–ª–∞—Ü–∏—è
    
    ## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã
    –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ —É—á–∏—Ç—ã–≤–∞–π:
    - –ß–∞—Å—Ç–æ—Ç—É –æ–±—Ä–∞—â–µ–Ω–∏–π (–ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –≤—ã–¥–µ–ª—è–π –æ—Ç–¥–µ–ª—å–Ω–æ)
    - –°–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è (–ø—Ä–æ—Å—Ç—ã–µ vs —Ç—Ä–µ–±—É—é—â–∏–µ —ç–∫—Å–ø–µ—Ä—Ç–∞)
    - –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –æ–∫—Ä–∞—Å–∫—É (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ vs –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ)
    - –°—Ä–æ—á–Ω–æ—Å—Ç—å (–ø–ª–∞–Ω–æ–≤—ã–µ vs —Ç—Ä–µ–±—É—é—â–∏–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è)
    
    ## –§–æ—Ä–º–∞—Ç –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
    1. –ù–∞–∑–≤–∞–Ω–∏—è (name): –ø–æ–Ω—è—Ç–Ω—ã–µ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º").
    2. ID (cluster_id): –∫–æ—Ä–æ—Ç–∫–∏–µ, –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, snake_case (–Ω–∞–ø—Ä–∏–º–µ—Ä: "network_issues", "billing_questions").
    3. –û–ø–∏—Å–∞–Ω–∏—è: –∫—Ä–∞—Ç–∫–∏–µ –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ.
    """

# =========================================================================
# –û–°–ù–û–í–ù–û–ô –ö–û–î (EXECUTION FLOW)
# =========================================================================

print("=" * 80)
print("STANDALONE –ü–†–ò–ú–ï–†: –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è —Å Ollama (Notebook Style)")
print("=" * 80)
print()

# -------------------------------------------------------------------------
# –®–ê–ì 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Ollama –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
# -------------------------------------------------------------------------
print("–®–∞–≥ 1: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Ollama –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞")
print("-" * 80)

try:
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä Ollama
    # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –∫–ª–∞—Å—Å OllamaProvider –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ (.env),
    # –ø–æ—ç—Ç–æ–º—É –º—ã –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞,
    # —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∫—Ä–∏–ø—Ç–∞.
    ollama = OllamaProvider()
    
    if OLLAMA_URL:
        ollama.api_url = OLLAMA_URL
    if OLLAMA_MODEL:
        ollama.model = OLLAMA_MODEL
    if LLM_TEMPERATURE is not None:
        ollama.temperature = LLM_TEMPERATURE
    if LLM_MAX_TOKENS is not None:
        ollama.max_tokens = LLM_MAX_TOKENS
        
    print(f"‚úì Ollama –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    print(f"  - API URL: {ollama.api_url}")
    print(f"  - Model: {ollama.model}")
    print(f"  - Temperature: {ollama.temperature}")
    print(f"  - Max Tokens: {ollama.max_tokens}")
    print()
    
    # –ü—Ä–æ–≤–µ—Ä–∏–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Ollama
    print("–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Ollama...")
    test_response = ollama.chat_completion(
        messages=[{"role": "user", "content": "–°–∫–∞–∂–∏ 'OK'"}],
        temperature=0.0,
        max_tokens=10
    )
    print(f"‚úì Ollama –æ—Ç–≤–µ—á–∞–µ—Ç: {test_response.strip()}")
    print()
    
except Exception as e:
    print(f"‚úó –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Ollama: {e}")
    print()
    print("–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:")
    print("  1. Ollama –∑–∞–ø—É—â–µ–Ω–∞: ollama serve")
    print("  2. –ú–æ–¥–µ–ª—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ollama pull qwen3:30b-a3b")
    print("  3. URL –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤ .env –∏–ª–∏ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö —Å–∫—Ä–∏–ø—Ç–∞")
    sys.exit(1)

# -------------------------------------------------------------------------
# –®–ê–ì 2: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
# -------------------------------------------------------------------------
print("\n–®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö")
print("-" * 80)

try:
    df = load_demo_data(DEMO_FILE_PATH, limit=LIMIT_ROWS)
    print()
    print("–ü–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±—Ä–∞—â–µ–Ω–∏–π:")
    print(df[["text", "request_id"]].head(3))
    print()
    
except Exception as e:
    print(f"‚úó –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
    sys.exit(1)

# -------------------------------------------------------------------------
# –®–ê–ì 3: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
# -------------------------------------------------------------------------
print("\n–®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞")
print("-" * 80)

business_context = create_custom_business_context()
print("‚úì –ë–∏–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–∑–¥–∞–Ω")
print("\n–§—Ä–∞–≥–º–µ–Ω—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:")
print(business_context[:300] + "...")
print()

# -------------------------------------------------------------------------
# –®–ê–ì 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ pipeline
# -------------------------------------------------------------------------
print("\n–®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ pipeline –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏")
print("-" * 80)

# –°–æ–∑–¥–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è pipeline
settings = Settings(
    clustering_batch_size=CLUSTERING_BATCH_SIZE,
    max_clusters_per_batch=MAX_CLUSTERS_PER_BATCH,
    min_requests_per_cluster=MIN_REQUESTS_PER_CLUSTER,
    default_temperature=LLM_TEMPERATURE,
    parallel_batch_size=PARALLEL_BATCH_SIZE,
)

# –°–æ–∑–¥–∞–µ–º pipeline —Å Ollama –∏ –±–∏–∑–Ω–µ—Å-–∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
pipeline = ClusteringPipeline(
    llm_provider=ollama,
    business_context=business_context,
    settings=settings
)

print("‚úì Pipeline –Ω–∞—Å—Ç—Ä–æ–µ–Ω")
print(f"  - –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞: {settings.clustering_batch_size}")
print(f"  - –ú–∞–∫—Å. –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∑–∞ –±–∞—Ç—á: {settings.max_clusters_per_batch}")
print(f"  - –ú–∏–Ω. –æ–±—Ä–∞—â–µ–Ω–∏–π –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ: {settings.min_requests_per_cluster}")
print()

# -------------------------------------------------------------------------
# –®–ê–ì 5: –ó–∞–ø—É—Å–∫ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
# -------------------------------------------------------------------------
print("\n–®–∞–≥ 5: –ó–∞–ø—É—Å–∫ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏")
print("-" * 80)
print(f"–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º {len(df)} –æ–±—Ä–∞—â–µ–Ω–∏–π...")
print("(–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç)")
print()

start_time = datetime.now()

try:
    # –ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    batch_count = 0
    for partial_result in pipeline.fit_partial(
        df,
        text_column="text",
        batch_size=settings.clustering_batch_size
    ):
        batch_count += 1
        progress = (partial_result.processed_rows / partial_result.total_rows) * 100
        
        print(f"–ë–∞—Ç—á {batch_count}:")
        print(f"  ‚îú‚îÄ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {partial_result.processed_rows}/{partial_result.total_rows} ({progress:.1f}%)")
        print(f"  ‚îú‚îÄ –ù–æ–≤—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: {len(partial_result.new_clusters)}")
        print(f"  ‚îî‚îÄ –í—Å–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: {len(pipeline.get_clusters())}")
        
        if partial_result.new_clusters:
            for cluster in partial_result.new_clusters[:3]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3
                print(f"      ‚Ä¢ {cluster.name}")
        print()
    
    elapsed = (datetime.now() - start_time).total_seconds()
    print(f"‚úì –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ {elapsed:.1f} —Å–µ–∫—É–Ω–¥")
    print()
    
except Exception as e:
    print(f"‚úó –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏: {e}")
    traceback.print_exc()
    sys.exit(1)

# -------------------------------------------------------------------------
# –®–ê–ì 6: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
# -------------------------------------------------------------------------
print("\n–®–∞–≥ 6: –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
print("-" * 80)

# –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
clusters = pipeline.get_clusters()

print(f"\nüìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
print(f"  ‚Ä¢ –í—Å–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏–π: {len(df)}")
print(f"  ‚Ä¢ –ù–∞–π–¥–µ–Ω–æ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: {len(clusters)}")
print(f"  ‚Ä¢ –°—Ä–µ–¥–Ω–µ–µ –æ–±—Ä–∞—â–µ–Ω–∏–π –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä: {len(df) / len(clusters) if clusters else 0:.1f}")
print()

# –¢–æ–ø-10 –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –ø–æ —Ä–∞–∑–º–µ—Ä—É
print("üèÜ –¢–û–ü-10 –ö–õ–ê–°–¢–ï–†–û–í –ü–û –ö–û–õ–ò–ß–ï–°–¢–í–£ –û–ë–†–ê–©–ï–ù–ò–ô:")
print()

sorted_clusters = sorted(clusters, key=lambda c: c.count, reverse=True)
for i, cluster in enumerate(sorted_clusters[:10], 1):
    print(f"{i:2d}. {cluster.name}")
    print(f"    ‚Ä¢ –û–±—Ä–∞—â–µ–Ω–∏–π: {cluster.count}")
    print(f"    ‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ: {cluster.summary[:100]}...")
    print()

# -------------------------------------------------------------------------
# –®–ê–ì 7: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
# -------------------------------------------------------------------------
print("\n–®–∞–≥ 7: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")
print("-" * 80)

OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã
clusters_file = OUTPUT_DIR / f"clusters_{timestamp}.json"
pipeline.save_clusters(clusters_file)
print(f"‚úì –ö–ª–∞—Å—Ç–µ—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: {clusters_file}")

# –°–æ—Ö—Ä–∞–Ω—è–µ–º assignments (—Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±–∞—Ç—á–∞)
# –î–ª—è –ø–æ–ª–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ partial_result.assignments
assignments_file = OUTPUT_DIR / f"assignments_{timestamp}.csv"

# –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ refit (—ç—Ç–æ –¥–∞—Å—Ç –Ω–∞–º assignments –¥–ª—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö)
print("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–ª–Ω—ã—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π...")
full_result = pipeline.fit(df, text_column="text")
full_result.assignments.to_csv(assignments_file, index=False)
print(f"‚úì –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: {assignments_file}")

# –°–æ–∑–¥–∞–µ–º –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç
report_file = OUTPUT_DIR / f"report_{timestamp}.txt"
with open(report_file, "w", encoding="utf-8") as f:
    f.write("=" * 80 + "\n")
    f.write("–û–¢–ß–ï–¢ –ü–û –ö–õ–ê–°–¢–ï–†–ò–ó–ê–¶–ò–ò\n")
    f.write("=" * 80 + "\n\n")
    f.write(f"–î–∞—Ç–∞: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
    f.write(f"–ú–æ–¥–µ–ª—å: {ollama.model}\n")
    f.write(f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –æ–±—Ä–∞—â–µ–Ω–∏–π: {len(df)}\n")
    f.write(f"–ù–∞–π–¥–µ–Ω–æ –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: {len(clusters)}\n")
    f.write(f"–ü–æ–∫—Ä—ã—Ç–∏–µ: {full_result.coverage:.1f}%\n")
    f.write(f"–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: {elapsed:.1f} —Å–µ–∫\n\n")
    
    f.write("–ö–õ–ê–°–¢–ï–†–´ (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ —Ä–∞–∑–º–µ—Ä—É):\n")
    f.write("-" * 80 + "\n\n")
    
    for i, cluster in enumerate(sorted_clusters, 1):
        f.write(f"{i}. {cluster.name}\n")
        f.write(f"   ID: {cluster.cluster_id}\n")
        f.write(f"   –û–±—Ä–∞—â–µ–Ω–∏–π: {cluster.count}\n")
        f.write(f"   –û–ø–∏—Å–∞–Ω–∏–µ: {cluster.summary}\n")
        f.write(f"   –ö—Ä–∏—Ç–µ—Ä–∏–∏: {cluster.criteria}\n")
        f.write(f"   –ü—Ä–∏–º–µ—Ä—ã: {', '.join(cluster.sample_requests[:3])}\n")
        f.write("\n")

print(f"‚úì –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {report_file}")
print()

# =========================================================================
# –ó–ê–í–ï–†–®–ï–ù–ò–ï
# =========================================================================
print("=" * 80)
print("‚úÖ –ü–†–ò–ú–ï–† –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù!")
print("=" * 80)
print("–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤:")
print(f"  {OUTPUT_DIR}/")
